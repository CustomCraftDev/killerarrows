package killerarrows;

import net.milkbowl.vault.economy.EconomyResponse;
import net.milkbowl.vault.economy.EconomyResponse.ResponseType;

import org.bukkit.Material;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.Player;
import org.bukkit.entity.Projectile;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.event.entity.EntityShootBowEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.metadata.FixedMetadataValue;

public class EventListener implements Listener{

	Killerarrows plugin;
	
	public EventListener(Killerarrows plugin) {
		this.plugin = plugin;
	}
	
	
	// set damage of special arrow on whitelisted entity
	@EventHandler
	public void actionPerformed(EntityDamageByEntityEvent e) {
		if(e.getDamager() instanceof Projectile){
			if(e.getDamager().hasMetadata("ohko")){
				if(e.getEntity() instanceof Player){
					if(!plugin.bl_player.contains(((Player) e.getEntity()).getName())){
						e.setDamage(plugin.arrowdamage);
					}
				}
				else if(!plugin.bl_entity.contains(e.getEntity().getType())){
					e.setDamage(plugin.arrowdamage);
				}
			}
		}
	}
	
	
	// special arrow shoot event
	@EventHandler
	public void actionPerformed(EntityShootBowEvent e) {
		if(e.getEntity() instanceof Player){
			Player p = (Player) e.getEntity();
			if(plugin.allarrowscost){
				EconomyResponse response = plugin.economy.withdrawPlayer(p, plugin.arrowcost);
				if(response.type.equals(ResponseType.FAILURE) || response.type.equals(ResponseType.NOT_IMPLEMENTED)){
					p.sendMessage(plugin.msg_eco);
					e.setCancelled(true);
				}
			}
			if(plugin.players.contains(p.getName())){
				e.getProjectile().setMetadata("ohko", new FixedMetadataValue(plugin, true));
				plugin.players.remove(p);
				p.sendMessage(plugin.msg_arrow_shot);
			}
		}
	}
	
		
	// equip dequip special arrow
	@EventHandler
	public void actionPerformed(PlayerInteractEvent e) {
		Player p = e.getPlayer();
		if(e.getAction().equals(Action.RIGHT_CLICK_AIR) || e.getAction().equals(Action.RIGHT_CLICK_BLOCK)){
			if(p.getItemInHand().getType().equals(Material.ARROW)){
				if(p.getItemInHand().getEnchantmentLevel(Enchantment.ARROW_DAMAGE) == 10){
					if(plugin.players.contains(p.getName())){
						plugin.players.remove(p.getName());
						p.getInventory().addItem(plugin.arrow);
						p.sendMessage(plugin.msg_arrow);
						p.sendMessage(plugin.msg_arrow_dequip);
					}
					else{
						ItemStack item = p.getItemInHand();
						if(item.getAmount() > 1){
							item.setAmount(item.getAmount() - 1);
						}
						else{
							item.setType(Material.AIR);
						}
						plugin.players.add(p.getName());
						p.sendMessage(plugin.msg_arrow_equip);
					}
				}
			}
		}
	}
	
	
}
