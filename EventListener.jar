package killerarrows;

import org.bukkit.Material;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.Player;
import org.bukkit.entity.Projectile;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.event.entity.EntityShootBowEvent;
import org.bukkit.event.inventory.InventoryType;
import org.bukkit.event.inventory.PrepareItemCraftEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.metadata.FixedMetadataValue;

public class EventListener implements Listener{

	Killerarrows plugin;
	
	public EventListener(Killerarrows plugin) {
		this.plugin = plugin;
	}
	
	
	// set damage of special arrow
	@EventHandler
	public void actionPerformed(EntityDamageByEntityEvent e) {
		if(e.getDamager() instanceof Projectile){
			if(e.getDamager().hasMetadata("ohko")){
				e.setDamage(plugin.arrowdamage);
			}
		}
	}
	
	
	// special arrow shoot event
	@EventHandler
	public void actionPerformed(EntityShootBowEvent e) {
		if(e.getEntity() instanceof Player){
			Player p = (Player) e.getEntity();
			if(plugin.players.contains(p)){
				e.getProjectile().setMetadata("ohko", new FixedMetadataValue(plugin, true));
				plugin.players.remove(p);
				p.sendMessage(plugin.msg_arrow_shot);
			}
		}
	}
	
	
   @EventHandler
   public void restrictCrafting(PrepareItemCraftEvent e) {
	   if (e.getView().getType() == InventoryType.WORKBENCH){
		   boolean[] found = new boolean[9];
		   
		   for (ItemStack item: e.getInventory().getMatrix()) {
			   //check crafting table ...
		   }
		   if (!found[0] || !found[1] || !found[2] || !found[3] || !found[4] || !found[5] || !found[6] || !found[7] || !found[8]) {
			   e.getRecipe().getResult().setType(Material.AIR);
		   }
		   else{
			   e.getRecipe().getResult().setType(Material.ARROW);
		   }
	   }
   }
	
	// equip dequip special arrow
	@EventHandler
	public void actionPerformed(PlayerInteractEvent e) {
		Player p = e.getPlayer();
		if(e.getAction().equals(Action.RIGHT_CLICK_AIR) || e.getAction().equals(Action.RIGHT_CLICK_BLOCK)){
			if(p.getItemInHand().getType().equals(Material.ARROW)){
				if(p.getItemInHand().getEnchantmentLevel(Enchantment.ARROW_DAMAGE) == 10){
					if(plugin.players.contains(p)){
						plugin.players.remove(p);
						plugin.arrow(p);
						p.sendMessage(plugin.msg_arrow_dequip);
					}
					else{
						ItemStack item = p.getItemInHand();
						if(item.getAmount() > 1){
							item.setAmount(item.getAmount() - 1);
						}
						else{
							item.setType(Material.AIR);
						}
						plugin.players.add(p);
						p.sendMessage(plugin.msg_arrow_equip);
					}
				}
			}
		}
	}
	
	
}
